# Резервное копирование #
1. Настроить стенд Vagrant с двумя виртуальными машинами backup (192.168.56.160) и client(192.168.56.150);
2. Настроить удалённый бэкап каталога /etc с сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:
- Директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. Для демонстрации используется хранилище размером 2 GB;
- Репозиторий для резервных копий зашифрован ключом либо паролем;
- Имя бэкапа содержит информацию о времени его снятия;
- Глубина бэкапа - один год, хранить можно по последней копии на конец месяца, кроме последних трёх. Последние три месяца должны содержать копии на каждый день. Т.е. необходима правильная настройка политики удаления старых бэкапов.
- Резервная копия снимается каждые 5 минут в целях демонстрации;
- Подготовлен скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо Systemd таймера;
- Настроено логирование процесса бэкапа. Весь вывод перенаправляется в logger c соответствующим тэгом.
 ### Исходные данные ###
&ensp;&ensp;ПК на Linux c 8 ГБ ОЗУ или виртуальная машина (ВМ) с включенной Nested Virtualization.<br/>
&ensp;&ensp;Предварительно установленное и настроенное ПО:<br/>
&ensp;&ensp;&ensp;Hashicorp Vagrant (https://www.vagrantup.com/downloads);<br/>
&ensp;&ensp;&ensp;Oracle VirtualBox (https://www.virtualbox.org/wiki/Linux_Downloads).<br/>
&ensp;&ensp;&ensp;Ansible (https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).<br/>
&ensp;&ensp;Все действия проводились с использованием Vagrant 2.4.0, VirtualBox 7.0.18, Ansible 9.4.0 и образа ubuntu/jammy64 версии 20240301.0.0. <br/> 
### Ход решения ###
1. Установка на backup и client сервере сервиса borgbackup:
```shell
root@backup:~# apt update; apt install borgbackup
...
root@backup:~# apt list installed borgbackup
Listing... Done
borgbackup/jammy,now 1.2.0-1 amd64 [installed]

root@client:~# apt update; apt install borgbackup
...
root@client:~# apt list installed borgbackup
Listing... Done
borgbackup/jammy,now 1.2.0-1 amd64 [installed]
```
2. Подготовка диска для хранения бэкапов на сервере backup:
```shell
root@backup:~# lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
loop0    7:0    0 63.9M  1 loop /snap/core20/2318
loop1    7:1    0 38.8M  1 loop /snap/snapd/21759
loop2    7:2    0   87M  1 loop /snap/lxd/28373
sda      8:0    0   40G  0 disk 
└─sda1   8:1    0   40G  0 part /
sdb      8:16   0   10M  0 disk 
sdc      8:32   0    2G  0 disk 

root@backup:~# fdisk /dev/sdc
...
root@backup:~# mkfs.xfs /dev/sdc1

root@backup:~# lsblk -f
NAME   FSTYPE   FSVER            LABEL           UUID                                 FSAVAIL FSUSE% MOUNTPOINTS
loop0  squashfs 4.0                                                                         0   100% /snap/core20/2318
loop1  squashfs 4.0                                                                         0   100% /snap/snapd/21759
loop2  squashfs 4.0                                                                         0   100% /snap/lxd/28373
sda                                                                                                  
└─sda1 ext4     1.0              cloudimg-rootfs fcc2d875-3a1b-45f7-861d-5e85a5a4a697   37.1G     4% /
sdb    iso9660  Joliet Extension cidata          2024-07-01-15-58-39-00                              
sdc                                                                                                  
└─sdc1 xfs                                       a595a9c7-5d2f-4581-ae9e-66d2abff7bed    1.9G     2% /var/backup
```
3. Создание точки монтирования на сервере backup и присоединения к ней раздела диска:
```shell
root@backup:~# mkdir /var/backup
root@backup:~# nano /etc/fstab
...
root@backup:~# cat /etc/fstab
LABEL=cloudimg-rootfs	/	 ext4	discard,errors=remount-ro	0 1
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
#VAGRANT-END
/dev/sdc1 /var/backup xfs defaults 0 0
```
4. Создание пользователя borg и назначение соответствующих прав точке монтирования:
```shell
root@backup:~# useradd borg -m
root@backup:~# passwd borg
...
root@backup:~# chown borg:borg /var/backup
```
5. Подготовка к подключению по SSH на серевере backup
``` shell
root@backup:~# su - borg
borg@backup:~$ mkdir .ssh
borg@backup:~$ touch .ssh/authorized_keys
borg@backup:~$ chmod 700 .ssh
borg@backup:~$ chmod 600 .ssh/authorized_keys
```
6. Генерирование ключа SSH на сервере client и добавление данных сервера backup в файл known_hosts:
```shell
root@client:~# ssh-keygen -t rsa -N '' -f /root/.ssh/id_rsa <<< y

root@client:~# ssh-keyscan 192.168.56.160 >> ~/.ssh/known_hosts
```
7. Копирование открытого ключа на сервер backup в описываемом случае осуществлялось вручную. Кроме данного способа можно использовать команду ssh-copy-id, либо просто копировать ключ по SSH. Однако для двух последних способов необходимо, чтобы на удалённом хосте в SSH была настроена авторизация по паролю.
8. Инициализация репозитория borg на сервере backup c  client сервера:
```shell
root@client:~# borg init --encryption=repokey borg@192.168.56.160:/var/backup/
...
``` 
9. Автоматизация создания бэкапов с помощью Systemd. Подготовка сервиса и таймера в каталоге /etc/systemd/system/
```shell
root@client:~# nano /etc/systemd/system/borg.service
...
root@client:~# cat /etc/systemd/system/borg.service
[Unit]
Description=Borg Backup

[Service]
Type=oneshot
Environment="BORG_PASSPHRASE=otus2024"
Environment=REPO=borg@192.168.56.160:/var/backup/
Environment=BACKUP_TARGET=/etc
ExecStart=/bin/borg create   \
          --stats                          \
          ${REPO}::etc-{now:%%Y-%%m-%%d_%%H:%%M:%%S} ${BACKUP_TARGET}
ExecStart=/bin/borg check ${REPO}
ExecStart=/bin/borg prune  \
    --keep-within 1d       \
    --keep-daily  90       \
    --keep-monthly 12      \
    --keep-yearly  1       \
    ${REPO}
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=borg_backup

root@client:~# nano /etc/systemd/system/borg.timer
...
root@client:~# cat /etc/systemd/system/borg.timer
[Unit]
Description=Borg Backup

[Timer]
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target

root@client:~# systemctl enable borg-backup.timer

root@client:~# systemctl start borg-backup.timer

root@client:~# systemctl list-timers borg-backup.timer
NEXT                        LEFT               LAST                        PASSED       UNIT                           ACTIVATES                       
Sun 2024-07-07 18:15:49 UTC 5s left            Sun 2024-07-07 18:10:49 UTC 4min 54s ago borg.timer                     borg.service
```
10. Проверка работы настроенной системы резервного копирования:
```shell
root@client:~# borg list borg@192.168.56.160:/var/backup
Enter passphrase for key ssh://borg@192.168.56.160/var/backup: 
...
etc-2024-07-07_17:53:49              Sun, 2024-07-07 17:53:50 [9dde381eb751ec7121bedc7fe18105ef52a3d86e561759a51602d03ecb60066d]
etc-2024-07-07_17:59:49              Sun, 2024-07-07 17:59:50 [ea75a9ba117f24c10936ea5991975d8c129f741ebd2d455fded48afb299e14b6]
etc-2024-07-07_18:04:52              Sun, 2024-07-07 18:04:53 [bd27ff7e962a016717f2f3640d9f1443dd33eadd4b703930dd136a8bd30d2c30]
etc-2024-07-07_18:10:49              Sun, 2024-07-07 18:10:50 [e61b0fa40854fb67d4483956252e91045a523fac9bbc92202950fb69bd8b5eed]
etc-2024-07-07_18:16:24              Sun, 2024-07-07 18:16:26 [5581667325b3a026997a57be5ef32395cf7ecb340c916c0f5835c28e39d7c5a5]

root@client:~# tail -f /var/log/syslog
Jul  7 18:16:24 ubuntu-jammy systemd[1]: Starting Borg Backup...
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: ------------------------------------------------------------------------------
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Repository: ssh://borg@192.168.56.160/var/backup
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Archive name: etc-2024-07-07_18:16:24
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Archive fingerprint: 5581667325b3a026997a57be5ef32395cf7ecb340c916c0f5835c28e39d7c5a5
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Time (start): Sun, 2024-07-07 18:16:26
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Time (end):   Sun, 2024-07-07 18:16:26
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Duration: 0.29 seconds
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Number of files: 695
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Utilization of max. archive size: 0%
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: ------------------------------------------------------------------------------
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]:                        Original size      Compressed size    Deduplicated size
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: This archive:                2.11 MB            939.57 kB                604 B
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: All archives:               63.42 MB             28.17 MB              1.00 MB
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]:                        Unique chunks         Total chunks
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: Chunk index:                     693                20580
Jul  7 18:16:26 ubuntu-jammy borg_backup[5759]: ------------------------------------------------------------------------------
Jul  7 18:16:30 ubuntu-jammy systemd[1]: borg.service: Deactivated successfully.
Jul  7 18:16:30 ubuntu-jammy systemd[1]: Finished Borg Backup.
Jul  7 18:16:30 ubuntu-jammy systemd[1]: borg.service: Consumed 3.101s CPU time.
```
11. Кроме того, для автоматизированного конфигурирования серверов client и backup исполнен плейбук Ansible и соответствующим образом настроен провизионинг в Vagrant. В качестве особенностей при автоматическом конфигурировании в данном проекте, стоит отметить, что перед запуском плейбука Ansible все сервера должны быть запущены:
```shell
dem@calculate ~/vagrant/17_DZ $ vagrant up --no-provision
...
dem@calculate ~/vagrant/17_DZ $ vagrant up --provision
``` 
